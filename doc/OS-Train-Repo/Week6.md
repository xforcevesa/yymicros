# Week 6

## 和向老师讨论情况

### 短期目标

实现简单的定制化宏内核，大致情况如下：

1. 制作一个用户库，提供不同类型的 syscall。
2. 应用程序根据需要选择对应的 syscall，和自身打包在一起编译得到二进制文件，并传递出一个使用的 syscall 清单。
3. 内核根据给出的 syscall 清单，选择性的提供对应的 syscall 进行服务。当前暂时不考虑去阉割syscall的功能。因此需要根据 syscall 所依赖的模块来选择性地启动内核，提供不同的接口。



### 需要实现的功能

1. 支持分离某些模块：为了支持宏内核的启动，文件驱动、页表空间、进程控制是不能删改的，但是比如信号、网络等大型模块、以及任务模块下的互斥锁实现等小型功能均是可以依据所需要的系统调用来进行定制的。但本次训练不求分离所有模块，只做一些示范性的分离，代表这种分离的思想可行。
2. 支持定制接口：为了实现这个功能，需要对 syscall 层模块做进一步的模块化。短期目标是按照所需要的syscall所属的模块，来批量提供这个模块中的所有syscall（如只要求open，可能会同时提供同类的open、write、close）。未来若有能力，还会继续细化到单个syscall。



### 期望效果

1. 生成的内核镜像大小有明显变化
2. 内核减少不必要的检查，从而达到编译速度和运行性能的提高。
3. 内核模块关系更加清晰，模块不仅可以加还可以删



### 长期目标

在定制内核的要求下，每一个模块之间的关系会更加地清晰。可以仿照redleaf的思想，将模块与程序之间的隔离从特权级之间的隔离转化为编程语言层面的隔离，每一个模块属于一个domain，不同的domain之间通过一个特定的domain进行通信，从而使得模块的插入可以变得更加便捷。

而在此基础上可以尝试**让模块的代码和数据分离存储**，即当模块的代码改变时不会影响原有数据和状态。若实现这一点，则使得动态升级模块成为可能。



## 拆分进展

### 大模块拆分--axnet

网络模块作为一个较为独立的模块，并不会影响核心模块的运行。它也是一个适合入手进行拆分的模块。以这个模块来阐述拆分思路。

#### 调整内容

首先将与网络关系较大的部分 syscall 如 syscall_bind 等独立出来作为一个类，认为当应用程序调用了属于这个类里面的系统调用时，就需要引入网络相关的模块。

之后对文件关系做出如下调整：

1. 新建 `modules/syscall/syscall_utils` crate，用于存储和系统调用相关的结构体、错误码等，进行统一
2. 新建`modules/syscall/syscall_net` crate，用于接管所有和网络相关的 syscall 接口实现，并对外提供一个 syscall id 类，里面存储了所有接管的 syscall id。。
3. 在 `ulib/axstarry` 用户库中，若当前包含了网络模块，则在处理 syscall 时判断当前 syscall 是否属于网络的 id 类，若是则把当前的请求转发给网络模块，否则转发给其他模块。
4. 之后需要实现的便是根据给定的 syscall id 列表，调整 axstarry 的编译选项，选择是否包括网络模块 `modules/syscall/syscall_net`。

#### 效果

当前第四步尚未实现，因此手动调整编译选项。在不加入 net 选项时，生成的内核镜像相比于加入时从 500kb 降到了 400kb，内核镜像大小变化较为明显。并且在不加入 net 选项时确实未对外提供网络接口，会提示接口不存在。





